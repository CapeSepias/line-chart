/*! line-chart - v0.0.1 - 2013-05-22
* https://github.com/angular-d3/line-chart
* Copyright (c) 2013 Angular D3; Licensed ,  */
angular.module("n3-charts.linechart",[]).factory("n3utils",function(){return{getDefaultMargins:function(){return{top:20,right:50,bottom:30,left:50}},clean:function(t){d3.select(t).select("svg").remove()},bootstrap:function(t,e){d3.select(t).classed("chart",!0);var n=e.width,a=e.height,r=d3.select(t).append("svg").attr("width",n).attr("height",a).append("g").attr("transform","translate("+e.left+","+e.top+")");return r},getTextWidth:function(t){return Math.max(25,6.7*t.length)},getWidestOrdinate:function(t,e){var n="";return t.forEach(function(t){e.forEach(function(e){(""+t[e.y]).length>(""+n).length&&(n=t[e.y])})}),n},createAxes:function(t,e,n){var a=void 0!==n.y2,r=e.width,i=e.height;r=r-e.left-e.right,i=i-e.top-e.bottom;var o="date"===n.x.type?d3.time.scale().rangeRound([0,r]):d3.scale.linear().rangeRound([0,r]),s=d3.scale.linear().rangeRound([i,0]),l=d3.scale.linear().rangeRound([i,0]),c=d3.svg.axis().scale(o).orient("bottom"),u=d3.svg.axis().scale(s).orient("left"),d=d3.svg.axis().scale(l).orient("right"),f=this;return{xScale:o,yScale:s,y2Scale:l,xAxis:c,yAxis:u,y2Axis:d,andAddThemIf:function(e){return e&&(t.append("g").attr("class","x axis").attr("transform","translate(0,"+i+")").call(c),t.append("g").attr("class","y axis").call(u),a&&t.append("g").attr("class","y2 axis").attr("transform","translate("+r+", 0)").call(d),f.addTooltips(t,r,i,a)),{xScale:o,yScale:s,y2Scale:l,xAxis:c,yAxis:u,y2Axis:d}}}},addTooltips:function(t,e,n,a){var r=24,i=18,o=t.append("g").attr({id:"xTooltip",opacity:0});o.append("path").attr({transform:"translate(0,"+(n+1)+")"}),o.append("text").style({"text-anchor":"middle"}).attr({width:r,height:i,"font-family":"monospace","font-size":10,transform:"translate(0,"+(n+19)+")",fill:"white","text-rendering":"geometric-precision"});var s=t.append("g").attr({id:"yTooltip",opacity:0});if(s.append("path"),s.append("text").attr({width:i,height:r,"font-family":"monospace","font-size":10,fill:"white","text-rendering":"geometric-precision"}),a){var l=t.append("g").attr({id:"y2Tooltip",opacity:0,transform:"translate("+e+",0)"});l.append("path"),l.append("text").attr({width:i,height:r,"font-family":"monospace","font-size":10,fill:"white","text-rendering":"geometric-precision"})}},createContent:function(t){t.append("g").attr("class","content")},drawLines:function(t,e,n,a){var r={y:this.createLeftLineDrawer(e,a),y2:this.createRightLineDrawer(e,a)};return t.select(".content").selectAll(".lineGroup").data(n.filter(function(t){return"line"===t.type||"area"===t.type})).enter().append("g").style("stroke",function(t){return t.color}).attr("class",function(t){return"lineGroup series_"+t.index}).append("path").attr("class","line").attr("d",function(t){return r[t.axis](t.values)}).style({fill:"none","stroke-width":"1px"}),this},createLeftLineDrawer:function(t,e){return d3.svg.line().x(function(e){return t.xScale(e.x)}).y(function(e){return t.yScale(e.value)}).interpolate(e)},createRightLineDrawer:function(t,e){return d3.svg.line().x(function(e){return t.xScale(e.x)}).y(function(e){return t.y2Scale(e.value)}).interpolate(e)},drawArea:function(t,e,n,a){var r={y:this.createLeftAreaDrawer(e,a),y2:this.createRightAreaDrawer(e,a)};return t.select(".content").selectAll(".areaGroup").data(n.filter(function(t){return"area"===t.type})).enter().append("g").style("fill",function(t){return t.color}).attr("class",function(t){return"areaGroup series_"+t.index}).append("path").style("opacity","0.3").attr("class","area").attr("d",function(t){return r[t.axis](t.values)}),this},createLeftAreaDrawer:function(t,e){return d3.svg.area().x(function(e){return t.xScale(e.x)}).y0(function(){return t.yScale(0)}).y1(function(e){return t.yScale(e.value)}).interpolate(e)},createRightAreaDrawer:function(t,e){return d3.svg.area().x(function(e){return t.xScale(e.x)}).y0(function(){return t.y2Scale(0)}).y1(function(e){return t.y2Scale(e.value)}).interpolate(e)},getBestColumnWidth:function(t,e){if(!e||0===e.length)return 10;var n=e[0].values.length+2,a=e.length,r=3,i=t.width-t.left-t.right;return(i-(n-1)*r)/(n*a)},drawColumns:function(t,e,n,a){n=n.filter(function(t){return"column"===t.type});var r=d3.scale.ordinal().domain(n.map(function(t){return t.name})).rangeRoundBands([0,n.length*a],.05),i=this,o=t.select(".content").selectAll(".columnGroup").data(n).enter().append("g").attr("class",function(t){return"columnGroup series_"+t.index}).style("fill",function(t){return t.color}).style("fill-opacity",.8).attr("transform",function(t){return"translate("+(r(t.name)-n.length*a/2)+",0)"}).on("mouseover",function(n){var a=d3.select(d3.event.target);i.onMouseOver(t,{series:n,x:a.attr("x"),y:e[n.axis+"Scale"](a.datum().value),datum:a.datum()})}).on("mouseout",function(){d3.select(d3.event.target).attr("r",2),i.onMouseOut(t)});return o.selectAll("rect").data(function(t){return t.values}).enter().append("rect").attr("width",a).attr("x",function(t){return e.xScale(t.x)}).attr("y",function(t){return e[t.axis+"Scale"](Math.max(0,t.value))}).attr("height",function(t){return Math.abs(e[t.axis+"Scale"](t.value)-e[t.axis+"Scale"](0))}),this},drawDots:function(t,e,n){var a=this;return t.select(".content").selectAll(".dotGroup").data(n.filter(function(t){return"line"===t.type||"area"===t.type})).enter().append("g").attr("class",function(t){return"dotGroup series_"+t.index}).attr("fill",function(t){return t.color}).on("mouseover",function(e){var n=d3.select(d3.event.target);n.attr("r",4),a.onMouseOver(t,{series:e,x:n.attr("cx"),y:n.attr("cy"),datum:n.datum()})}).on("mouseout",function(){d3.select(d3.event.target).attr("r",2),a.onMouseOut(t)}).selectAll(".dot").data(function(t){return t.values}).enter().append("circle").attr({"class":"dot",r:2,cx:function(t){return e.xScale(t.x)},cy:function(t){return e[t.axis+"Scale"](t.value)}}).style({stroke:"white","stroke-width":"2px"}),this},onMouseOver:function(t,e){this.updateXTooltip(t,e),"y2"===e.series.axis?this.updateY2Tooltip(t,e):this.updateYTooltip(t,e)},onMouseOut:function(t){this.hideTooltips(t)},updateXTooltip:function(t,e){var n,a=t.select("#xTooltip").transition().attr({opacity:1,transform:"translate("+e.x+",0)"});n=e.series.xFormatter?""+e.series.xFormatter(e.datum.x):""+e.datum.x,a.select("text").text(n),a.select("path").attr("fill",e.series.color).attr("d",this.getXTooltipPath(n))},getXTooltipPath:function(t){var e=this.getTextWidth(t),n=18,a=5;return"m-"+e/2+" "+a+" "+"l0 "+n+" "+"l"+e+" 0 "+"l0 "+"-"+n+"l-"+(e/2-a)+" 0 "+"l-"+a+" -"+n/4+" "+"l-"+a+" "+n/4+" "+"l-"+(e/2-a)+" 0z"},updateYTooltip:function(t,e){var n=t.select("#yTooltip").transition().attr({opacity:1,transform:"translate(0, "+e.y+")"}),a=""+e.datum.value,r=n.select("text").text(a);r.attr("transform","translate(-"+(this.getTextWidth(a)+3)+",3)"),n.select("path").attr("fill",e.series.color).attr("d",this.getYTooltipPath(a))},getYTooltipPath:function(t){var e=this.getTextWidth(t),n=18,a=5;return"m0 0l-"+a+" -"+a+" "+"l0 -"+(n/2-a)+" "+"l-"+e+" 0 "+"l0 "+n+" "+"l"+e+" 0 "+"l0 -"+(n/2-a)+"l-"+a+" "+a+"z"},updateY2Tooltip:function(t,e){var n=t.select("#y2Tooltip").transition().attr({opacity:1}),a=""+e.datum.value,r=n.select("text").text(a);r.attr("transform","translate(5, "+(parseFloat(e.y)+3)+")"),n.select("path").attr({fill:e.series.color,d:this.getY2TooltipPath(a),transform:"translate(0, "+e.y+")"})},getY2TooltipPath:function(t){var e=this.getTextWidth(t),n=18,a=5;return"m0 0l"+a+" "+a+" "+"l0 "+(n/2-a)+" "+"l"+e+" 0 "+"l0 -"+n+" "+"l-"+e+" 0 "+"l0 "+(n/2-a)+" "+"l-"+a+" "+a+"z"},hideTooltips:function(t){t.select("#xTooltip").transition().attr({opacity:0}),t.select("#yTooltip").transition().attr({opacity:0}),t.select("#y2Tooltip").transition().attr({opacity:0})},getDataPerSeries:function(t,e){var n=e.series,a=e.axes;if(!(n&&n.length&&t&&t.length))return[];var r=[];return n.forEach(function(e){var n={xFormatter:a.x.tooltipFormatter,index:r.length,name:e.y,values:[],color:e.color,axis:e.axis||"y",type:e.type||"line"};t.forEach(function(t){n.values.push({x:t.x,value:t[e.y],axis:e.axis||"y"})}),r.push(n)}),r},setScalesDomain:function(t,e,n,a){this.setXScale(t.xScale,e,n);var r=n.filter(function(t){return"y2"!==t.axis}),i=n.filter(function(t){return"y2"===t.axis});t.yScale.domain(this.yExtent(r,e)).nice(),t.y2Scale.domain(this.yExtent(i,e)).nice(),a.selectAll(".x.axis").call(t.xAxis),a.selectAll(".y.axis").call(t.yAxis),a.selectAll(".y2.axis").call(t.y2Axis)},yExtent:function(t,e){var n=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;return t.forEach(function(t){n=Math.min(n,d3.min(e,function(e){return e[t.y]})),a=Math.max(a,d3.max(e,function(e){return e[t.y]}))}),[n,a]},setXScale:function(t,e,n){t.domain(d3.extent(e,function(t){return t.x})),n.filter(function(t){return"column"===t.type}).length&&this.adjustXScaleForColumns(t,e)},adjustXScaleForColumns:function(t,e){var n=this.getAverageStep(e,"x"),a=t.domain();angular.isDate(a[0])?t.domain([new Date(a[0].getTime()-n),new Date(a[1].getTime()+n)]):t.domain([a[0]-n,a[1]+n])},getAverageStep:function(t,e){for(var n=0,a=t.length-1,r=0;a>r;r++)n+=t[r+1][e]-t[r][e];return n/a},haveSecondYAxis:function(t){var e=!1;return angular.forEach(t,function(t){e=e||"y2"===t.axis}),e},resetMargins:function(t){var e=this.getDefaultMargins();t.left=e.left,t.right=e.right,t.top=e.top,t.bottom=e.bottom},adjustMargins:function(t,e,n){if(this.resetMargins(t),n&&0!==n.length){var a=e.series,r=a.filter(function(t){return"y2"!==t.axis}),i=this.getWidestOrdinate(n,r);t.left=this.getTextWidth(""+i)+20;var o=a.filter(function(t){return"y2"===t.axis});if(0!==o.length){var s=this.getWidestOrdinate(n,o);t.right=this.getTextWidth(""+s)+20}}},adjustMarginsForThumbnail:function(t){t.left=0,t.right=0,t.top=0,t.bottom=0},drawLegend:function(t,e,n){for(var a=[0],r=1;e.length>r;r++){var i=e[r-1].label||e[r-1].y;a.push(this.getTextWidth(i)+a[r-1]+20)}var o=this,s=t.append("g").attr("class","legend"),l=s.selectAll(".legendItem").data(e).enter().append("g").attr({"class":"legendItem",transform:function(t,e){return"translate("+a[e]+","+(n.height-25)+")"}});return l.append("circle").attr({fill:function(t){return t.color},r:4,stroke:function(t){return t.color},"stroke-width":"2px"}).on("click",function(e,n){d3.select(this).attr("fill-opacity",o.toggleSeries(t,n)?"1":"0.2")}),l.append("text").attr({"font-family":"monospace","font-size":10,transform:"translate(10, 3)","text-rendering":"geometric-precision"}).text(function(t){return t.label||t.y}),this},toggleSeries:function(t,e){var n=!1;return t.select(".content").selectAll(".series_"+e).attr("opacity",function(){return"0"===d3.select(this).attr("opacity")?(n=!0,"1"):(n=!1,"0")}),n},getDefaultOptions:function(){return{lineMode:"linear",axes:{x:{type:"linear"},y:{}},series:[]}},sanitizeOptions:function(t){return null===t||void 0===t?this.getDefaultOptions():(t.series||(t.series=[]),t.axes||(t.axes={x:{type:"linear"},y:{}}),t.axes.y||(t.axes.y={}),t.axes.x||(t.axes.x={type:"linear"}),t.axes.x.type||(t.axes.x.type="linear"),t.lineMode||(t.lineMode="linear"),this.haveSecondYAxis(t.series)&&(t.axes.y2={}),t)}}}).directive("linechart",["n3utils","$window","$timeout",function(t,e,n){var a=function(a,r,i){var o=t.getDefaultMargins();a.updateDimensions=function(t){t.width=r[0].parentElement.offsetWidth||900,t.height=r[0].parentElement.offsetHeight||500},a.update=function(){a.updateDimensions(o),a.redraw(o)},a.redraw=function(e){var n=t.sanitizeOptions(a.options),o=a.data,s=n.series,l=t.getDataPerSeries(o,n),c="thumbnail"===i.mode;c?t.adjustMarginsForThumbnail(e,n,o):t.adjustMargins(e,n,o),t.clean(r[0]);var u=t.bootstrap(r[0],e),d=t.createAxes(u,e,n.axes).andAddThemIf(!c);t.createContent(u),c||t.drawLegend(u,s,e);var f=n.lineMode;if(l.length>0){t.setScalesDomain(d,o,n.series,u);var p=t.getBestColumnWidth(e,l);t.drawArea(u,d,l,f).drawColumns(u,d,l,p).drawLines(u,d,l,f).drawDots(u,d,l)}};var s,l=function(){n.cancel(s),s=n(a.update,1)};e.addEventListener("resize",l),a.$watch("data",a.update),a.$watch("options",a.update,!0)};return{replace:!0,restrict:"E",scope:{data:"=",options:"="},template:"<div></div>",link:a}}]);