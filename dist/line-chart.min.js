/*! line-chart - v0.0.1 - 2013-05-21
* https://github.com/angular-d3/line-chart
* Copyright (c) 2013 Angular D3; Licensed ,  */
angular.module("n3-charts.linechart",[]).factory("n3utils",function(){return{getDefaultMargins:function(){return{top:20,right:50,bottom:30,left:50}},clean:function(t){d3.select(t).select("svg").remove()},bootstrap:function(t,e){d3.select(t).classed("chart",!0);var n=e.width,r=e.height,a=d3.select(t).append("svg").attr("width",n).attr("height",r).append("g").attr("transform","translate("+e.left+","+e.top+")");return a},getTextWidth:function(t){return Math.max(25,6.7*t.length)},getWidestOrdinate:function(t,e){var n="";return t.forEach(function(t){e.forEach(function(e){(""+t[e.y]).length>(""+n).length&&(n=t[e.y])})}),n},createAxes:function(t,e,n){var r=e.width,a=e.height;r=r-e.left-e.right,a=a-e.top-e.bottom;var i=d3.scale.linear().rangeRound([0,r]),o=d3.scale.linear().rangeRound([a,0]),l=d3.scale.linear().rangeRound([a,0]),s=d3.svg.axis().scale(i).orient("bottom"),c=d3.svg.axis().scale(o).orient("left"),u=d3.svg.axis().scale(l).orient("right"),d=this;return{xScale:i,yScale:o,y2Scale:l,xAxis:s,yAxis:c,y2Axis:u,andAddThemIf:function(e){return e&&(t.append("g").attr("class","x axis").attr("transform","translate(0,"+a+")").call(s),t.append("g").attr("class","y axis").call(c),n&&t.append("g").attr("class","y2 axis").attr("transform","translate("+r+", 0)").call(u),d.addTooltips(t,r,a,n)),{xScale:i,yScale:o,y2Scale:l,xAxis:s,yAxis:c,y2Axis:u}}}},addTooltips:function(t,e,n,r){var a=24,i=18,o=t.append("g").attr({id:"xTooltip",opacity:0});o.append("path").attr({transform:"translate(0,"+(n+1)+")"}),o.append("text").style({"text-anchor":"middle"}).attr({width:a,height:i,"font-family":"monospace","font-size":10,transform:"translate(0,"+(n+19)+")",fill:"white","text-rendering":"geometric-precision"});var l=t.append("g").attr({id:"yTooltip",opacity:0});if(l.append("path"),l.append("text").attr({width:i,height:a,"font-family":"monospace","font-size":10,fill:"white","text-rendering":"geometric-precision"}),r){var s=t.append("g").attr({id:"y2Tooltip",opacity:0,transform:"translate("+e+",0)"});s.append("path"),s.append("text").attr({width:i,height:a,"font-family":"monospace","font-size":10,fill:"white","text-rendering":"geometric-precision"})}},createContent:function(t){t.append("g").attr("class","content")},drawLines:function(t,e,n,r){var a={y:this.createLeftLineDrawer(e,r),y2:this.createRightLineDrawer(e,r)};return t.select(".content").selectAll(".lineGroup").data(n.filter(function(t){return"line"===t.type||"area"===t.type})).enter().append("g").style("stroke",function(t){return t.color}).attr("class",function(t){return"lineGroup series_"+t.index}).append("path").attr("class","line").attr("d",function(t){return a[t.axis](t.values)}).style({fill:"none","stroke-width":"1px"}),this},createLeftLineDrawer:function(t,e){return d3.svg.line().x(function(e){return t.xScale(e.x)}).y(function(e){return t.yScale(e.value)}).interpolate(e)},createRightLineDrawer:function(t,e){return d3.svg.line().x(function(e){return t.xScale(e.x)}).y(function(e){return t.y2Scale(e.value)}).interpolate(e)},drawArea:function(t,e,n,r){var a={y:this.createLeftAreaDrawer(e,r),y2:this.createRightAreaDrawer(e,r)};return t.select(".content").selectAll(".areaGroup").data(n.filter(function(t){return"area"===t.type})).enter().append("g").style("fill",function(t){return t.color}).attr("class",function(t){return"areaGroup series_"+t.index}).append("path").style("opacity","0.3").attr("class","area").attr("d",function(t){return a[t.axis](t.values)}),this},createLeftAreaDrawer:function(t,e){return d3.svg.area().x(function(e){return t.xScale(e.x)}).y0(function(){return t.yScale(0)}).y1(function(e){return t.yScale(e.value)}).interpolate(e)},createRightAreaDrawer:function(t,e){return d3.svg.area().x(function(e){return t.xScale(e.x)}).y0(function(){return t.y2Scale(0)}).y1(function(e){return t.y2Scale(e.value)}).interpolate(e)},getBestColumnWidth:function(t,e){if(!e||0===e.length)return 10;var n=e[0].values.length+2,r=e.length,a=3,i=t.width-t.left-t.right;return(i-(n-1)*a)/(n*r)},drawColumns:function(t,e,n,r){n=n.filter(function(t){return"column"===t.type});var a=d3.scale.ordinal().domain(n.map(function(t){return t.name})).rangeRoundBands([0,n.length*r],.05),i=this,o=t.select(".content").selectAll(".columnGroup").data(n).enter().append("g").attr("class",function(t){return"columnGroup series_"+t.index}).style("fill",function(t){return t.color}).style("fill-opacity",.8).attr("transform",function(t){return"translate("+(a(t.name)-n.length*r/2)+",0)"}).on("mouseover",function(n){var r=d3.select(d3.event.target);i.onMouseOver(t,{series:n,x:r.attr("x"),y:e[n.axis+"Scale"](r.datum().value),datum:r.datum()})}).on("mouseout",function(){d3.select(d3.event.target).attr("r",2),i.onMouseOut(t)});return o.selectAll("rect").data(function(t){return t.values}).enter().append("rect").attr("width",r).attr("x",function(t){return e.xScale(t.x)}).attr("y",function(t){return e[t.axis+"Scale"](Math.max(0,t.value))}).attr("height",function(t){return Math.abs(e[t.axis+"Scale"](t.value)-e[t.axis+"Scale"](0))}),this},drawDots:function(t,e,n){var r=this;return t.select(".content").selectAll(".dotGroup").data(n.filter(function(t){return"line"===t.type||"area"===t.type})).enter().append("g").attr("class",function(t){return"dotGroup series_"+t.index}).attr("fill",function(t){return t.color}).on("mouseover",function(e){var n=d3.select(d3.event.target);n.attr("r",4),r.onMouseOver(t,{series:e,x:n.attr("cx"),y:n.attr("cy"),datum:n.datum()})}).on("mouseout",function(){d3.select(d3.event.target).attr("r",2),r.onMouseOut(t)}).selectAll(".dot").data(function(t){return t.values}).enter().append("circle").attr({"class":"dot",r:2,cx:function(t){return e.xScale(t.x)},cy:function(t){return e[t.axis+"Scale"](t.value)}}).style({stroke:"white","stroke-width":"2px"}),this},onMouseOver:function(t,e){this.updateXTooltip(t,e),"y2"===e.series.axis?this.updateY2Tooltip(t,e):this.updateYTooltip(t,e)},onMouseOut:function(t){this.hideTooltips(t)},updateXTooltip:function(t,e){var n=t.select("#xTooltip").transition().attr({opacity:1,transform:"translate("+e.x+",0)"}),r=""+e.datum.x;n.select("text").text(r),n.select("path").attr("fill",e.series.color).attr("d",this.getXTooltipPath(r))},getXTooltipPath:function(t){var e=this.getTextWidth(t),n=18,r=5;return"m-"+e/2+" "+r+" "+"l0 "+n+" "+"l"+e+" 0 "+"l0 "+"-"+n+"l-"+(e/2-r)+" 0 "+"l-"+r+" -"+n/4+" "+"l-"+r+" "+n/4+" "+"l-"+(e/2-r)+" 0z"},updateYTooltip:function(t,e){var n=t.select("#yTooltip").transition().attr({opacity:1,transform:"translate(0, "+e.y+")"}),r=""+e.datum.value,a=n.select("text").text(r);a.attr("transform","translate(-"+(this.getTextWidth(r)+3)+",3)"),n.select("path").attr("fill",e.series.color).attr("d",this.getYTooltipPath(r))},getYTooltipPath:function(t){var e=this.getTextWidth(t),n=18,r=5;return"m0 0l-"+r+" -"+r+" "+"l0 -"+(n/2-r)+" "+"l-"+e+" 0 "+"l0 "+n+" "+"l"+e+" 0 "+"l0 -"+(n/2-r)+"l-"+r+" "+r+"z"},updateY2Tooltip:function(t,e){var n=t.select("#y2Tooltip").transition().attr({opacity:1}),r=""+e.datum.value,a=n.select("text").text(r);a.attr("transform","translate(5, "+(parseFloat(e.y)+3)+")"),n.select("path").attr({fill:e.series.color,d:this.getY2TooltipPath(r),transform:"translate(0, "+e.y+")"})},getY2TooltipPath:function(t){var e=this.getTextWidth(t),n=18,r=5;return"m0 0l"+r+" "+r+" "+"l0 "+(n/2-r)+" "+"l"+e+" 0 "+"l0 -"+n+" "+"l-"+e+" 0 "+"l0 "+(n/2-r)+" "+"l-"+r+" "+r+"z"},hideTooltips:function(t){t.select("#xTooltip").transition().attr({opacity:0}),t.select("#yTooltip").transition().attr({opacity:0}),t.select("#y2Tooltip").transition().attr({opacity:0})},getDataPerSeries:function(t,e){var n=e?e.series:null;if(!(n&&n.length&&t&&t.length))return[];var r=[];return n.forEach(function(e){var n={index:r.length,name:e.y,values:[],color:e.color,axis:e.axis||"y",type:e.type||"line"};t.forEach(function(t){n.values.push({x:t.x,value:t[e.y],axis:e.axis||"y"})}),r.push(n)}),r},setScalesDomain:function(t,e,n,r){this.setXScale(t.xScale,e,n);var a=n.filter(function(t){return"y2"!==t.axis}),i=n.filter(function(t){return"y2"===t.axis});t.yScale.domain(this.yExtent(a,e)).nice(),t.y2Scale.domain(this.yExtent(i,e)).nice(),r.selectAll(".x.axis").call(t.xAxis),r.selectAll(".y.axis").call(t.yAxis),r.selectAll(".y2.axis").call(t.y2Axis)},yExtent:function(t,e){var n=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;return t.forEach(function(t){n=Math.min(n,d3.min(e,function(e){return e[t.y]})),r=Math.max(r,d3.max(e,function(e){return e[t.y]}))}),[n,r]},setXScale:function(t,e,n){t.domain(d3.extent(e,function(t){return t.x})),n.filter(function(t){return"column"===t.type}).length&&this.adjustXScaleForColumns(t,e)},adjustXScaleForColumns:function(t,e){var n=this.getAverageStep(e,"x"),r=t.domain();t.domain([r[0]-n,r[1]+n])},getAverageStep:function(t,e){for(var n=0,r=t.length-1,a=0;r>a;a++)n+=t[a+1][e]-t[a][e];return n/r},haveSecondYAxis:function(t){var e=!1;return angular.forEach(t,function(t){e=e||"y2"===t.axis}),e},resetMargins:function(t){var e=this.getDefaultMargins();t.left=e.left,t.right=e.right,t.top=e.top,t.bottom=e.bottom},adjustMargins:function(t,e,n){if(this.resetMargins(t),n&&0!==n.length){var r=e&&e.series?e.series:[],a=r.filter(function(t){return"y2"!==t.axis}),i=this.getWidestOrdinate(n,a);t.left=this.getTextWidth(""+i)+20;var o=r.filter(function(t){return"y2"===t.axis});if(0!==o.length){var l=this.getWidestOrdinate(n,o);t.right=this.getTextWidth(""+l)+20}}},adjustMarginsForThumbnail:function(t){t.left=0,t.right=0,t.top=0,t.bottom=0},drawLegend:function(t,e,n){for(var r=[0],a=1;e.length>a;a++){var i=e[a-1].label||e[a-1].y;r.push(this.getTextWidth(i)+r[a-1]+20)}var o=this,l=t.append("g").attr("class","legend"),s=l.selectAll(".legendItem").data(e).enter().append("g").attr({"class":"legendItem",transform:function(t,e){return"translate("+r[e]+","+(n.height-25)+")"}});return s.append("circle").attr({fill:function(t){return t.color},r:4,stroke:function(t){return t.color},"stroke-width":"2px"}).on("click",function(e,n){d3.select(this).attr("fill-opacity",o.toggleSeries(t,n)?"1":"0.2")}),s.append("text").attr({"font-family":"monospace","font-size":10,transform:"translate(10, 3)","text-rendering":"geometric-precision"}).text(function(t){return t.label||t.y}),this},toggleSeries:function(t,e){var n=!1;return t.select(".content").selectAll(".series_"+e).attr("opacity",function(){return"0"===d3.select(this).attr("opacity")?(n=!0,"1"):(n=!1,"0")}),n}}}).directive("linechart",["n3utils","$window",function(t,e){var n=function(n,r,a){var i=t.getDefaultMargins();n.updateDimensions=function(t){t.width=r[0].parentElement.offsetWidth||900,t.height=r[0].parentElement.offsetHeight||500},n.update=function(){n.updateDimensions(i),n.redraw(i)},n.redraw=function(e){var i=n.data,o=n.options,l=o&&o.series?o.series:[],s=t.getDataPerSeries(i,o);"thumbnail"===a.mode?t.adjustMarginsForThumbnail(e,o,i):t.adjustMargins(e,o,i),t.clean(r[0]);var c=t.haveSecondYAxis(l),u=t.bootstrap(r[0],e),d=t.createAxes(u,e,c).andAddThemIf("thumbnail"!==a.mode);t.createContent(u);var f=o?o.lineMode:"linear";if(s.length>0){t.setScalesDomain(d,i,o.series,u);var p=t.getBestColumnWidth(e,s);t.drawArea(u,d,s,f).drawColumns(u,d,s,p).drawLines(u,d,s,f).drawDots(u,d,s).drawLegend(u,l,e)}},e.onresize=function(){n.update()},n.$watch("data",n.update),n.$watch("options",n.update,!0)};return{replace:!0,restrict:"E",scope:{data:"=",options:"="},template:"<div></div>",link:n}}]);